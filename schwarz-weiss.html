<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schwarz Wei√ü</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px;
            max-width: 1000px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        /* Login/Register Styles */
        .auth-container {
            max-width: 400px;
            margin: 0 auto;
        }

        .auth-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input, select, button {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Games Overview */
        .games-overview {
            display: none;
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .game-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ddd;
            position: relative;
        }

        .game-card h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .game-card-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .game-card-actions button {
            flex: 1;
        }

        .delete-btn {
            background: #dc3545 !important;
            color: white !important;
            border: none !important;
            padding: 8px 15px !important;
            border-radius: 5px !important;
            cursor: pointer !important;
            font-size: 0.9em !important;
            transition: background-color 0.3s !important;
            margin: 0 !important;
            width: auto !important;
        }

        .delete-btn:hover {
            background: #c82333 !important;
            transform: none !important;
            box-shadow: none !important;
        }

        .game-status {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .status-waiting { color: #ffa500; }
        .status-active { color: #28a745; }
        .status-finished { color: #6c757d; }

        /* Game Area */
        .game-container {
            display: none;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .game-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .player-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }

        .player-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        /* Tables */
        .guess-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .guess-table th,
        .guess-table td {
            padding: 8px 12px;
            text-align: center;
            border: 1px solid #ddd;
        }

        .guess-table th {
            background-color: #667eea;
            color: white;
            font-weight: bold;
        }

        .guess-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .word-cell {
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }

        .black-cell {
            background-color: #333 !important;
            color: white;
            font-weight: bold;
        }

        .white-cell {
            background-color: #f0f0f0 !important;
            color: #333;
            font-weight: bold;
        }

        /* Chat */
        .chat-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            height: 300px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            background: white;
        }

        .chat-message {
            margin-bottom: 8px;
            padding: 5px 10px;
            border-radius: 5px;
        }

        .chat-message.own {
            background: #e3f2fd;
            text-align: right;
        }

        .chat-message.other {
            background: #f5f5f5;
        }

        .chat-message.system {
            background: #fff3cd;
            text-align: center;
            font-style: italic;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
        }

        .send-btn {
            width: auto;
            padding: 12px 20px;
        }

        /* Status Messages */
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Secret Word Display */
        .secret-word-display {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
        }

        .secret-word-display strong {
            color: #1976d2;
            font-size: 1.2em;
        }

        /* Win Notification */
        .win-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            text-align: center;
            z-index: 1000;
            min-width: 300px;
            animation: winPop 0.6s ease-out;
        }

        .win-notification.lose {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        }

        .win-notification h2 {
            margin: 0 0 15px 0;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .win-notification p {
            margin: 10px 0;
            font-size: 1.2em;
        }

        .win-notification .secret-word {
            font-size: 1.5em;
            font-weight: bold;
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 10px;
            margin: 15px 0;
            letter-spacing: 2px;
        }

        .win-notification button {
            background: rgba(255,255,255,0.9);
            color: #333;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
        }

        .win-notification button:hover {
            background: white;
            transform: scale(1.05);
        }

        .win-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 999;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes winPop {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
            70% {
                transform: translate(-50%, -50%) scale(1.1);
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .game-content {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Schwarz Wei√ü</h1>

        <!-- Login/Register Area -->
        <div id="authArea" class="auth-container">
            <div class="auth-form">
                <h2>Anmelden</h2>
                <div class="form-group">
                    <label for="loginUsername">Benutzername:</label>
                    <input type="text" id="loginUsername" placeholder="Dein Benutzername">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Passwort:</label>
                    <input type="password" id="loginPassword" placeholder="Dein Passwort">
                </div>
                <button onclick="login()">Anmelden</button>
                <div id="loginStatus" class="status" style="display: none;"></div>
            </div>

            <div class="auth-form">
                <h2>Registrieren</h2>
                <div class="form-group">
                    <label for="registerUsername">Benutzername:</label>
                    <input type="text" id="registerUsername" placeholder="W√§hle einen Benutzernamen">
                </div>
                <div class="form-group">
                    <label for="registerPassword">Passwort:</label>
                    <input type="password" id="registerPassword" placeholder="W√§hle ein Passwort">
                </div>
                <button onclick="register()">Registrieren</button>
                <div id="registerStatus" class="status" style="display: none;"></div>
            </div>
        </div>

        <!-- Games Overview -->
        <div id="gamesArea" class="games-overview">
            <div class="user-info">
                <div>
                    <h2>Willkommen, <span id="currentUsername"></span>!</h2>
                </div>
                <div>
                    <button onclick="loadUserGames(true)" style="margin-right: 10px;">üîÑ Aktualisieren</button>
                    <button onclick="logout()">Abmelden</button>
                </div>
            </div>

            <button onclick="createNewGame()">Neues Spiel erstellen</button>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0 10px 0;">
                <h3>Deine Spiele</h3>
                <div>
                    <label for="sortBy" style="margin-right: 10px;">Sortieren:</label>
                    <select id="sortBy" onchange="loadUserGames()" style="width: auto; padding: 5px;">
                        <option value="newest">Neueste zuerst</option>
                        <option value="oldest">√Ñlteste zuerst</option>
                        <option value="activity">Letzte Aktivit√§t</option>
                    </select>
                </div>
            </div>
            <div id="gamesGrid" class="games-grid">
                <!-- Games will be loaded here -->
            </div>
            
            <h3>√ñffentliche Spiele (Suche Mitspieler)</h3>
            <div id="publicGamesGrid" class="games-grid">
                <!-- Public games will be loaded here -->
            </div>
        </div>

        <!-- Game Container -->
        <div id="gameContainer" class="game-container">
            <div class="game-header">
                <div>
                    <h2 id="gameTitle">Spiel</h2>
                    <p><strong>Spieler:</strong> <span id="players"></span></p>
                    <p><strong>Wortl√§nge:</strong> <span id="gameWordLength"></span> Buchstaben</p>
                </div>
                <div>
                    <button onclick="leaveGame()">Spiel verlassen</button>
                </div>
            </div>

            <!-- Game Setup Area -->
            <div id="gameSetup">
                <div class="player-section">
                    <h3>Spiel-Setup</h3>
                    <div class="form-group">
                        <label for="wordLength">Wortl√§nge:</label>
                        <select id="wordLength">
                            <option value="3">3 Buchstaben</option>
                            <option value="4">4 Buchstaben</option>
                            <option value="5" selected>5 Buchstaben</option>
                            <option value="6">6 Buchstaben</option>
                            <option value="7">7 Buchstaben</option>
                            <option value="8">8 Buchstaben</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="mySecretWord">Dein Geheimwort:</label>
                        <input type="text" id="mySecretWord" placeholder="Geheimwort eingeben" maxlength="8">
                    </div>
                    <button onclick="setSecretWord()">Wort best√§tigen</button>
                    <div id="setupStatus" class="status" style="display: none;"></div>
                </div>
            </div>

            <!-- Game Area -->
            <div id="gameArea" style="display: none;">
                <div class="secret-word-display">
                    <strong>Dein Geheimwort: <span id="mySecretWordDisplay"></span></strong>
                </div>

                <div class="game-content">
                    <!-- Left Column: My Guesses -->
                    <div class="player-section">
                        <h3>Meine Rateversuche</h3>
                        <div id="myGuessInput">
                            <input type="text" id="guessInput" placeholder="Dein Ratewort eingeben" maxlength="8">
                            <button onclick="makeGuess()" id="guessButton">Raten</button>
                        </div>
                        <table class="guess-table">
                            <thead>
                                <tr>
                                    <th>Wort</th>
                                    <th>Schwarz</th>
                                    <th>Wei√ü</th>
                                </tr>
                            </thead>
                            <tbody id="myGuessTableBody">
                                <tr>
                                    <td colspan="3" style="text-align: center; color: #666; font-style: italic;">Noch keine Rateversuche</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Right Column: Opponent Guesses -->
                    <div class="player-section">
                        <h3>Gegnerische Rateversuche</h3>
                        <table class="guess-table">
                            <thead>
                                <tr>
                                    <th>Wort</th>
                                    <th>Schwarz</th>
                                    <th>Wei√ü</th>
                                </tr>
                            </thead>
                            <tbody id="opponentGuessTableBody">
                                <tr>
                                    <td colspan="3" style="text-align: center; color: #666; font-style: italic;">Noch keine Rateversuche</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Chat Area -->
                <div class="chat-container">
                    <h3>Chat</h3>
                    <div id="chatMessages" class="chat-messages">
                        <!-- Chat messages will appear here -->
                    </div>
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" class="chat-input" placeholder="Nachricht eingeben..." onkeypress="if(event.key==='Enter') sendChatMessage()">
                        <button onclick="sendChatMessage()" class="send-btn">Senden</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // Firebase Konfiguration
        const firebaseConfig = {
            "apiKey": "AIzaSyDD90OTegdK2ntJf00isCu2UrqMJgG0z7o",
            "authDomain": "schwarzweiss-114be.firebaseapp.com",
            "databaseURL": "https://schwarzweiss-114be-default-rtdb.europe-west1.firebasedatabase.app",
            "projectId": "schwarzweiss-114be",
            "storageBucket": "schwarzweiss-114be.firebasestorage.app",
            "messagingSenderId": "639322789033",
            "appId": "1:639322789033:web:c516407fde77b83a4245b8"
        };

        // Firebase initialisieren
        console.log('Initialisiere Firebase...');
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        console.log('Firebase initialisiert:', database);

        // Global state
        let currentUser = null;
        let currentGameId = null;
        let gameRef = null;
        let gameState = {
            playerId: null,
            isHost: false,
            gameStarted: false,
            mySecretWord: '',
            wordLength: 5,
            winnerMessageShown: false,
            wordLengthMessageSent: false
        };
        
        // Simple cache for games data
        let gamesCache = {
            data: null,
            timestamp: 0,
            ttl: 10000 // 10 seconds cache
        };
        
        function invalidateGamesCache() {
            gamesCache.data = null;
            gamesCache.timestamp = 0;
        }

        // User Authentication
        async function register() {
            console.log('Register function called');
            
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value.trim();

            console.log('Username:', username, 'Password length:', password.length);

            if (!username || !password) {
                showStatus('registerStatus', 'Bitte alle Felder ausf√ºllen!', 'error');
                return;
            }

            if (username.length < 3) {
                showStatus('registerStatus', 'Benutzername muss mindestens 3 Zeichen haben!', 'error');
                return;
            }

            if (password.length < 4) {
                showStatus('registerStatus', 'Passwort muss mindestens 4 Zeichen haben!', 'error');
                return;
            }

            try {
                console.log('Checking if username exists...');
                // Check if username exists
                const userSnapshot = await database.ref(`users/${username}`).once('value');
                console.log('User check result:', userSnapshot.exists());
                
                if (userSnapshot.exists()) {
                    showStatus('registerStatus', 'Benutzername bereits vergeben!', 'error');
                    return;
                }

                console.log('Creating user...');
                // Create user
                await database.ref(`users/${username}`).set({
                    password: password, // In production: hash this!
                    createdAt: Date.now(),
                    gamesPlayed: 0
                });

                console.log('User created successfully');
                showStatus('registerStatus', 'Registrierung erfolgreich! Du kannst dich jetzt anmelden.', 'success');
                
                // Clear form
                document.getElementById('registerUsername').value = '';
                document.getElementById('registerPassword').value = '';

            } catch (error) {
                console.error('Registration error:', error);
                showStatus('registerStatus', 'Fehler bei der Registrierung: ' + error.message, 'error');
            }
        }

        async function login() {
            console.log('Login function called');
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            console.log('Login attempt for username:', username);

            if (!username || !password) {
                showStatus('loginStatus', 'Bitte alle Felder ausf√ºllen!', 'error');
                return;
            }

            try {
                console.log('Checking user credentials...');
                const userSnapshot = await database.ref(`users/${username}`).once('value');
                const userData = userSnapshot.val();
                
                console.log('User data retrieved:', userData ? 'found' : 'not found');

                if (!userData || userData.password !== password) {
                    showStatus('loginStatus', 'Ung√ºltiger Benutzername oder Passwort!', 'error');
                    return;
                }

                console.log('Login successful');
                currentUser = { username, ...userData };
                document.getElementById('currentUsername').textContent = username;
                
                showGamesOverview();
                loadUserGames();

            } catch (error) {
                console.error('Login error:', error);
                showStatus('loginStatus', 'Fehler beim Anmelden: ' + error.message, 'error');
            }
        }

        function logout() {
            currentUser = null;
            currentGameId = null;
            
            // Remove all Firebase listeners
            if (gameRef) {
                gameRef.off();
                gameRef = null;
            }
            database.ref('games').off();
            database.ref('.info/connected').off();
            
            // Reset UI
            document.getElementById('authArea').style.display = 'block';
            document.getElementById('gamesArea').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'none';
            
            // Clear forms
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        }

        function showGamesOverview() {
            document.getElementById('authArea').style.display = 'none';
            document.getElementById('gamesArea').style.display = 'block';
            document.getElementById('gameContainer').style.display = 'none';
            
            // Remove any existing listeners to prevent conflicts
            database.ref('games').off();
            
            // Set up optimized listeners for real-time updates
            initializeGameListeners();
        }

        function initializeGameListeners() {
            // Listen for game updates that affect the current user
            database.ref('games').on('child_changed', (snapshot) => {
                const game = snapshot.val();
                if (game && game.players && 
                   ((game.players.player1 && game.players.player1.name === currentUser.username) ||
                    (game.players.player2 && game.players.player2.name === currentUser.username))) {
                    
                    // Only reload if we're in the games overview
                    if (document.getElementById('gamesArea').style.display !== 'none') {
                        updateSingleGameCard(snapshot.key, game);
                    }
                }
            });
            
            database.ref('games').on('child_added', (snapshot) => {
                const game = snapshot.val();
                // Only reload for new waiting games or games involving current user
                if (game && game.status === 'waiting' && 
                    document.getElementById('gamesArea').style.display !== 'none') {
                    loadUserGames();
                }
            });
        }

        function updateSingleGameCard(gameId, game) {
            // Fast update of individual game card instead of reloading everything
            const existingCards = document.querySelectorAll('.game-card');
            const gameIdShort = gameId.substring(5, 13);
            
            for (const card of existingCards) {
                if (card.innerHTML.includes(gameIdShort)) {
                    const isOwnGame = game.players.player1.name === currentUser.username;
                    const newCard = createGameCard(gameId, game, isOwnGame);
                    card.replaceWith(newCard);
                    break;
                }
            }
        }

        // Games Management
        async function createNewGame() {
            if (!currentUser) return;

            console.log('Creating new game for user:', currentUser.username);

            try {
                // Check if user already has 3 active games
                const myGamesSnapshot = await database.ref('games').orderByChild('host').equalTo(currentUser.username).once('value');
                const myGames = myGamesSnapshot.val() || {};
                
                const activeGames = Object.values(myGames).filter(game => 
                    game.status === 'waiting' || game.status === 'active'
                );
                
                if (activeGames.length >= 3) {
                    alert('Du kannst maximal 3 Spiele gleichzeitig hosten. Bitte beende oder l√∂sche ein vorhandenes Spiel.');
                    return;
                }

                const gameId = 'game_' + Date.now();
                console.log('Game ID:', gameId);
                
                const gameData = {
                    host: currentUser.username,
                    status: 'waiting',
                    createdAt: Date.now(),
                    lastActivity: Date.now(),
                    gameState: {
                        wordLength: 5,
                        started: false,
                        currentTurn: 'player1',
                        winner: null
                    },
                    players: {
                        player1: {
                            name: currentUser.username,
                            ready: false,
                            secretWord: '',
                            guesses: {}
                        }
                    },
                    chat: {}
                };
                
                console.log('Creating game with data:', gameData);
                
                await database.ref(`games/${gameId}`).set(gameData);
                console.log('Game created successfully in Firebase');

                // Invalidate cache since we created a new game
                invalidateGamesCache();

                // Join immediately without waiting
                joinGameDirect(gameId, gameData);

            } catch (error) {
                console.error('Error creating game:', error);
                alert('Fehler beim Erstellen des Spiels: ' + error.message);
            }
        }

        function joinGameDirect(gameId, gameData) {
            console.log('Joining game directly with provided data');
            
            currentGameId = gameId;
            gameRef = database.ref(`games/${gameId}`);
            
            // Set up game state immediately since we know we're the host
            gameState.playerId = 'player1';
            gameState.isHost = true;
            
            // Set up game listener
            console.log('Setting up game listener...');
            gameRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    updateGameFromData(data);
                }
            });

            console.log('Showing game container...');
            showGameContainer();
        }

        async function loadUserGames(forceRefresh = false) {
            if (!currentUser) return;

            // Show loading indicators immediately
            const gamesGrid = document.getElementById('gamesGrid');
            const publicGamesGrid = document.getElementById('publicGamesGrid');
            gamesGrid.innerHTML = '<p style="text-align: center; color: #666;">L√§dt...</p>';
            publicGamesGrid.innerHTML = '<p style="text-align: center; color: #666;">L√§dt...</p>';
            
            try {
                console.log('Loading user games...');
                console.time('loadUserGames');
                
                let allGames;
                const now = Date.now();
                
                // Use cache if available and not expired (unless force refresh)
                if (!forceRefresh && 
                    gamesCache.data && 
                    (now - gamesCache.timestamp) < gamesCache.ttl) {
                    console.log('Using cached games data');
                    allGames = gamesCache.data;
                } else {
                    console.log('Fetching fresh games data from Firebase');
                    // Single query to get ALL games - much faster than multiple queries
                    const allGamesSnapshot = await database.ref('games').once('value');
                    allGames = allGamesSnapshot.val() || {};
                    
                    // Update cache
                    gamesCache.data = allGames;
                    gamesCache.timestamp = now;
                }
                
                console.log('Firebase query completed, processing data...');
                
                const myGames = {};
                const publicGames = {};
                
                // Single loop through all games - very fast in-memory filtering
                for (const [gameId, game] of Object.entries(allGames)) {
                    if (!game || !game.players) continue;
                    
                    const isMyGame = (
                        (game.players.player1 && game.players.player1.name === currentUser.username) ||
                        (game.players.player2 && game.players.player2.name === currentUser.username)
                    );
                    
                    if (isMyGame) {
                        myGames[gameId] = game;
                    } else if (!currentGameId && 
                               game.status === 'waiting' &&
                               game.players.player1 && 
                               game.players.player1.name !== currentUser.username &&
                               !game.players.player2) {
                        publicGames[gameId] = game;
                    }
                }

                console.log('Data processing completed, sorting...');
                
                // Sort my games based on user selection
                const sortBy = document.getElementById('sortBy')?.value || 'newest';
                const sortedMyGames = sortGames(myGames, sortBy);

                console.log('Sorting completed, updating DOM...');

                // Use DocumentFragments for better DOM performance
                const myGamesFragment = document.createDocumentFragment();
                const publicGamesFragment = document.createDocumentFragment();
                
                // Display my games
                if (sortedMyGames.length === 0) {
                    const emptyMsg = document.createElement('p');
                    emptyMsg.style.textAlign = 'center';
                    emptyMsg.style.color = '#666';
                    emptyMsg.textContent = 'Noch keine Spiele erstellt.';
                    myGamesFragment.appendChild(emptyMsg);
                } else {
                    sortedMyGames.forEach(({ gameId, game }) => {
                        const gameCard = createGameCard(gameId, game, true);
                        myGamesFragment.appendChild(gameCard);
                    });
                }

                // Display public games  
                if (Object.keys(publicGames).length === 0) {
                    const emptyMsg = document.createElement('p');
                    emptyMsg.style.textAlign = 'center';
                    emptyMsg.style.color = '#666';
                    emptyMsg.textContent = 'Keine offenen Spiele verf√ºgbar.';
                    publicGamesFragment.appendChild(emptyMsg);
                } else {
                    // Sort public games by creation date (newest first) for better UX
                    const sortedPublicGames = Object.entries(publicGames)
                        .sort(([,a], [,b]) => b.createdAt - a.createdAt);
                    
                    sortedPublicGames.forEach(([gameId, game]) => {
                        const gameCard = createGameCard(gameId, game, false);
                        publicGamesFragment.appendChild(gameCard);
                    });
                }

                console.log('DOM fragments prepared, updating UI...');

                // Update DOM in one operation each - fastest possible
                gamesGrid.innerHTML = '';
                gamesGrid.appendChild(myGamesFragment);
                
                publicGamesGrid.innerHTML = '';
                publicGamesGrid.appendChild(publicGamesFragment);

                console.timeEnd('loadUserGames');
                console.log('User games loaded successfully');

            } catch (error) {
                console.error('Fehler beim Laden der Spiele:', error);
                console.timeEnd('loadUserGames');
                gamesGrid.innerHTML = '<p style="text-align: center; color: #f00;">Fehler beim Laden der Spiele</p>';
                publicGamesGrid.innerHTML = '<p style="text-align: center; color: #f00;">Fehler beim Laden der Spiele</p>';
            }
        }

        function sortGames(gamesObject, sortBy) {
            const gamesArray = Object.keys(gamesObject).map(gameId => ({
                gameId,
                game: gamesObject[gameId]
            }));
            
            switch(sortBy) {
                case 'oldest':
                    return gamesArray.sort((a, b) => a.game.createdAt - b.game.createdAt);
                case 'activity':
                    return gamesArray.sort((a, b) => (b.game.lastActivity || b.game.createdAt) - (a.game.lastActivity || a.game.createdAt));
                case 'newest':
                default:
                    return gamesArray.sort((a, b) => b.game.createdAt - a.game.createdAt);
            }
        }

        function createGameCard(gameId, game, isOwnGame) {
            const gameCard = document.createElement('div');
            gameCard.className = 'game-card';
            
            let statusClass = 'status-waiting';
            let statusText = 'Warten auf Spieler';
            
            if (game.status === 'active') {
                statusClass = 'status-active';
                statusText = 'Spiel l√§uft';
            } else if (game.status === 'finished') {
                statusClass = 'status-finished';
                statusText = 'Beendet';
            }

            const player2Name = game.players.player2 ? game.players.player2.name : 'Wartet...';
            const gameIdShort = gameId.substring(5, 13);
            
            let buttonText = 'Beitreten';
            let buttonAction = `joinGame('${gameId}')`;
            let buttonDisabled = '';
            let deleteButton = '';
            
            if (isOwnGame) {
                if (game.status === 'finished') {
                    buttonText = 'Beendet';
                    buttonDisabled = 'disabled';
                } else {
                    buttonText = '√ñffnen';
                }
                
                // Add delete button for own games
                const canDelete = game.status === 'waiting' || game.status === 'finished';
                deleteButton = `<button class="delete-btn" onclick="deleteGame('${gameId}')" ${canDelete ? '' : 'disabled'}>üóëÔ∏è L√∂schen</button>`;
            } else {
                if (game.status !== 'waiting') {
                    buttonText = 'Nicht verf√ºgbar';
                    buttonDisabled = 'disabled';
                }
            }

            const lastActivity = game.lastActivity ? new Date(game.lastActivity).toLocaleString() : 'Nie';
            
            gameCard.innerHTML = `
                <h3>Spiel ${gameIdShort}</h3>
                <div class="game-status ${statusClass}">${statusText}</div>
                <p><strong>Erstellt:</strong> ${new Date(game.createdAt).toLocaleString()}</p>
                <p><strong>Letzte Aktivit√§t:</strong> ${lastActivity}</p>
                <p><strong>Host:</strong> ${game.players.player1.name}</p>
                <p><strong>Spieler 2:</strong> ${player2Name}</p>
                ${!isOwnGame ? `<p><strong>Spiel-ID:</strong> ${gameIdShort}</p>` : ''}
                <div class="game-card-actions">
                    <button onclick="${buttonAction}" ${buttonDisabled}>
                        ${buttonText}
                    </button>
                    ${deleteButton}
                </div>
            `;
            
            return gameCard;
        }

        async function deleteGame(gameId) {
            if (!confirm('M√∂chtest du dieses Spiel wirklich l√∂schen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.')) {
                return;
            }
            
            try {
                console.log('Deleting game:', gameId);
                await database.ref(`games/${gameId}`).remove();
                console.log('Game deleted successfully');
                
                // Invalidate cache since we deleted a game
                invalidateGamesCache();
                
                // Reload games list (will use fresh data due to cache invalidation)
                loadUserGames();
                
                // Show success message
                alert('Spiel erfolgreich gel√∂scht!');
                
            } catch (error) {
                console.error('Error deleting game:', error);
                alert('Fehler beim L√∂schen des Spiels: ' + error.message);
            }
        }

        async function joinGame(gameId) {
            if (!currentUser) {
                console.error('No current user when trying to join game');
                return;
            }

            // Prevent multiple calls
            if (currentGameId === gameId) {
                console.log('Already joining/joined this game, skipping...');
                return;
            }

            try {
                console.log('Joining game:', gameId, 'as user:', currentUser.username);
                
                currentGameId = gameId;
                gameRef = database.ref(`games/${gameId}`);

                // Show game container immediately for better UX
                showGameContainer();

                const gameSnapshot = await gameRef.once('value');
                const gameData = gameSnapshot.val();

                console.log('Game data retrieved:', gameData);

                if (!gameData) {
                    console.error('Game not found!');
                    alert('Spiel nicht gefunden!');
                    currentGameId = null;
                    gameRef = null;
                    showGamesOverview();
                    return;
                }

                // Determine player role and set up listener in parallel
                let playerUpdates = null;
                
                if (gameData.players.player1.name === currentUser.username) {
                    console.log('Joining as player1 (host)');
                    gameState.playerId = 'player1';
                    gameState.isHost = true;
                } else if (gameData.players.player2 && gameData.players.player2.name === currentUser.username) {
                    console.log('Joining as existing player2');
                    gameState.playerId = 'player2';
                    gameState.isHost = false;
                } else {
                    // Join as player2
                    console.log('Joining as new player2');
                    gameState.playerId = 'player2';
                    gameState.isHost = false;
                    
                    playerUpdates = {
                        [`players/player2`]: {
                            name: currentUser.username,
                            ready: false,
                            secretWord: '',
                            guesses: {}
                        }
                    };
                }

                console.log('Player ID set to:', gameState.playerId, 'Is Host:', gameState.isHost);

                // Set up game listener AFTER setting player ID
                console.log('Setting up game listener...');
                gameRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        updateGameFromData(data);
                    }
                });

                // Update Firebase with player2 data if needed (non-blocking for UI)
                if (playerUpdates) {
                    console.log('Adding player2 data...');
                    gameRef.update(playerUpdates).then(() => {
                        console.log('Player2 data added successfully');
                    }).catch((error) => {
                        console.error('Error adding player2:', error);
                    });
                }

                console.log('Game joined successfully');

            } catch (error) {
                console.error('Error joining game:', error);
                alert('Fehler beim Beitreten: ' + error.message);
                currentGameId = null;
                if (gameRef) {
                    gameRef.off();
                    gameRef = null;
                }
                showGamesOverview();
            }
        }

        function leaveGame() {
            if (gameRef) {
                gameRef.off();
                gameRef = null;
            }
            currentGameId = null;
            
            // Reset game state
            gameState = {
                playerId: null,
                isHost: false,
                gameStarted: false,
                mySecretWord: '',
                wordLength: 5,
                winnerMessageShown: false,
                wordLengthMessageSent: false
            };
            
            showGamesOverview();
            loadUserGames();
        }

        function showGameContainer() {
            document.getElementById('authArea').style.display = 'none';
            document.getElementById('gamesArea').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'block';
            
            // Show setup initially and reset form
            document.getElementById('gameSetup').style.display = 'block';
            document.getElementById('gameArea').style.display = 'none';
            
            // Reset and enable form elements
            document.getElementById('mySecretWord').disabled = false;
            document.getElementById('mySecretWord').value = '';
            document.getElementById('wordLength').disabled = !gameState.isHost; // Only host can change length
            const button = document.querySelector('button[onclick="setSecretWord()"]');
            if (button) {
                button.disabled = false;
                button.textContent = 'Wort best√§tigen';
            }
        }

        // Game Logic
        function setSecretWord() {
            console.log('setSecretWord() called');
            
            // Check if player ID is set
            if (!gameState.playerId) {
                console.error('Player ID is not set! Cannot set secret word.');
                showStatus('setupStatus', 'Fehler: Spieler-ID nicht gesetzt. Bitte Spiel neu beitreten.', 'error');
                return;
            }
            
            const word = document.getElementById('mySecretWord').value.trim().toUpperCase();
            const wordLength = parseInt(document.getElementById('wordLength').value);

            console.log('Word:', word, 'Length:', wordLength, 'Player ID:', gameState.playerId);

            if (!word) {
                showStatus('setupStatus', 'Bitte ein Wort eingeben!', 'error');
                return;
            }

            if (word.length !== wordLength) {
                showStatus('setupStatus', `Das Wort muss genau ${wordLength} Buchstaben haben!`, 'error');
                return;
            }

            if (!/^[A-Z]+$/.test(word)) {
                showStatus('setupStatus', 'Nur Buchstaben erlaubt (A-Z)!', 'error');
                return;
            }

            gameState.mySecretWord = word;
            gameState.wordLength = wordLength;

            console.log('Preparing Firebase updates...');
            
            // Send to Firebase
            const updates = {};
            updates[`players/${gameState.playerId}/secretWord`] = word;
            updates[`players/${gameState.playerId}/ready`] = true;
            updates['lastActivity'] = Date.now();
            
            console.log('Player ID:', gameState.playerId, 'Is Host:', gameState.isHost);
            
            // Only host can set word length
            if (gameState.isHost) {
                updates['gameState/wordLength'] = wordLength;
                console.log('Host setting word length to:', wordLength);
                
                // Only send chat message once when host sets word length
                if (!gameState.wordLengthMessageSent) {
                    gameState.wordLengthMessageSent = true;
                    addChatMessage(`Wortl√§nge wurde auf ${wordLength} Buchstaben festgelegt.`, 'system');
                }
            }

            console.log('Updates to send:', updates);

            gameRef.update(updates).then(() => {
                console.log('Secret word updates sent successfully');
                showStatus('setupStatus', 'Wort best√§tigt! Warte auf Mitspieler...', 'success');
                
                // Disable the form after successful submission
                document.getElementById('mySecretWord').disabled = true;
                document.getElementById('wordLength').disabled = true;
                const button = document.querySelector('button[onclick="setSecretWord()"]');
                if (button) {
                    button.disabled = true;
                    button.textContent = 'Wort best√§tigt ‚úì';
                }
                
            }).catch((error) => {
                console.error('Error updating secret word:', error);
                showStatus('setupStatus', 'Fehler beim Speichern: ' + error.message, 'error');
            });
        }

        function updateGameFromData(gameData) {
            console.log('updateGameFromData called');
            
            // Synchronize word length
            if (gameData.gameState.wordLength && gameData.gameState.wordLength !== gameState.wordLength) {
                gameState.wordLength = gameData.gameState.wordLength;
                document.getElementById('wordLength').value = gameData.gameState.wordLength;
                
                // Disable word length for non-host if already set
                if (!gameState.isHost && gameData.gameState.wordLength) {
                    document.getElementById('wordLength').disabled = true;
                }
            }

            // Check if both players are ready
            console.log('Checking if game can start...');
            console.log('Player1:', gameData.players.player1);
            console.log('Player2:', gameData.players.player2);
            console.log('Game started:', gameState.gameStarted);
            
            if (gameData.players.player1 && gameData.players.player2) {
                console.log('Player1 ready:', gameData.players.player1.ready);
                console.log('Player2 ready:', gameData.players.player2.ready);
                
                if (gameData.players.player1.ready && gameData.players.player2.ready && !gameState.gameStarted) {
                    console.log('Both players ready - starting game!');
                    startGame(gameData);
                } else {
                    console.log('Waiting for players to be ready...');
                }
            } else {
                console.log('Waiting for second player...');
            }

            if (gameState.gameStarted) {
                updateGameArea(gameData);
            }

            // Update chat
            updateChat(gameData.chat || {});
        }

        function startGame(gameData) {
            // Mark game as started
            if (gameState.isHost) {
                gameRef.update({
                    'status': 'active',
                    'gameState/started': true
                });
            }

            document.getElementById('gameSetup').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';

            gameState.gameStarted = true;

            // Initialize UI
            document.getElementById('players').textContent = 
                `${gameData.players.player1.name} vs ${gameData.players.player2.name}`;
            document.getElementById('gameWordLength').textContent = gameData.gameState.wordLength;
            
            // Show own secret word
            document.getElementById('mySecretWordDisplay').textContent = gameState.mySecretWord;

            updateGameArea(gameData);
            
            addChatMessage('Spiel gestartet! Viel Erfolg!', 'system');
        }

        function updateGameArea(gameData) {
            const isMyTurn = gameData.gameState.currentTurn === gameState.playerId;
            
            // Update guess input
            const guessInput = document.getElementById('guessInput');
            const guessButton = document.getElementById('guessButton');
            
            if (gameData.gameState.winner) {
                guessInput.disabled = true;
                guessButton.disabled = true;
                guessButton.textContent = 'Spiel beendet';
                
                // Show winner message ONLY ONCE
                const winnerName = gameData.players[gameData.gameState.winner].name;
                const isWinner = gameData.gameState.winner === gameState.playerId;
                
                // Only add winner message once and only if we haven't shown it yet
                if (!gameState.winnerMessageShown) {
                    gameState.winnerMessageShown = true;
                    
                    // Add winner message WITHOUT triggering Firebase update
                    const chatMessages = document.getElementById('chatMessages');
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'chat-message system';
                    messageDiv.textContent = `üéâ ${winnerName} hat gewonnen!`;
                    chatMessages.appendChild(messageDiv);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                    // Show win notification popup
                    showWinNotification(isWinner, winnerName, gameData);
                }
                
            } else if (isMyTurn) {
                guessInput.disabled = false;
                guessButton.disabled = false;
                guessButton.textContent = 'Raten';
            } else {
                guessInput.disabled = true;
                guessButton.disabled = true;
                guessButton.textContent = 'Warten...';
            }

            // Update guess histories
            updateGuessHistoriesFromData(gameData);
        }

        function updateGuessHistoriesFromData(gameData) {
            console.log('updateGuessHistoriesFromData called');
            
            try {
                const myPlayer = gameData.players[gameState.playerId];
                const opponentId = gameState.playerId === 'player1' ? 'player2' : 'player1';
                const opponentPlayer = gameData.players[opponentId];

                console.log('My player data:', myPlayer);
                console.log('Opponent player data:', opponentPlayer);

                // My guesses table
                const myTableBody = document.getElementById('myGuessTableBody');
                if (!myTableBody) {
                    console.error('myGuessTableBody not found!');
                    return;
                }
                
                myTableBody.innerHTML = '';
                if (myPlayer.guesses) {
                    Object.values(myPlayer.guesses).forEach(guess => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="word-cell">${guess.word}</td>
                            <td class="black-cell">${guess.blacks}</td>
                            <td class="white-cell">${guess.whites}</td>
                        `;
                        myTableBody.appendChild(row);
                    });
                }
                
                if (myTableBody.children.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="3" style="text-align: center; color: #666; font-style: italic;">Noch keine Rateversuche</td>';
                    myTableBody.appendChild(row);
                }

                // Opponent guesses table
                const opponentTableBody = document.getElementById('opponentGuessTableBody');
                if (!opponentTableBody) {
                    console.error('opponentGuessTableBody not found!');
                    return;
                }
                
                opponentTableBody.innerHTML = '';
                if (opponentPlayer.guesses) {
                    Object.values(opponentPlayer.guesses).forEach(guess => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="word-cell">${guess.word}</td>
                            <td class="black-cell">${guess.blacks}</td>
                            <td class="white-cell">${guess.whites}</td>
                        `;
                        opponentTableBody.appendChild(row);
                    });
                }
                
                if (opponentTableBody.children.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="3" style="text-align: center; color: #666; font-style: italic;">Noch keine Rateversuche</td>';
                    opponentTableBody.appendChild(row);
                }
                
                console.log('Guess histories updated successfully');
                
            } catch (error) {
                console.error('Error in updateGuessHistoriesFromData:', error);
            }
        }

        function makeGuess() {
            console.log('makeGuess() called');
            
            const guess = document.getElementById('guessInput').value.trim().toUpperCase();
            console.log('Guess input:', guess);

            if (!guess) {
                alert('Bitte ein Wort eingeben!');
                return;
            }

            if (guess.length !== gameState.wordLength) {
                alert(`Das Wort muss genau ${gameState.wordLength} Buchstaben haben!`);
                return;
            }

            if (!/^[A-Z]+$/.test(guess)) {
                alert('Nur Buchstaben erlaubt (A-Z)!');
                return;
            }

            console.log('Guess validation passed, getting opponent secret word...');

            // Get opponent's secret word
            const opponentId = gameState.playerId === 'player1' ? 'player2' : 'player1';
            console.log('Opponent ID:', opponentId);
            
            gameRef.child(`players/${opponentId}/secretWord`).once('value', (snapshot) => {
                console.log('Retrieved opponent secret word snapshot');
                const opponentSecretWord = snapshot.val();
                console.log('Opponent secret word:', opponentSecretWord ? 'found' : 'not found');
                
                if (!opponentSecretWord) {
                    alert('Fehler: Geheimwort des Gegners nicht gefunden!');
                    return;
                }

                console.log('Calculating guess result...');
                // Calculate result
                const result = calculateGuessResult(guess, opponentSecretWord);
                console.log('Guess result:', result);
                
                // Save guess
                const guessId = 'guess_' + Date.now();
                console.log('Saving guess with ID:', guessId);
                
                const updates = {};
                updates[`players/${gameState.playerId}/guesses/${guessId}`] = {
                    word: guess,
                    blacks: result.blacks,
                    whites: result.whites,
                    timestamp: Date.now()
                };
                
                // Update last activity
                updates['lastActivity'] = Date.now();

                console.log('Updates to be sent:', updates);

                // Check for win
                if (result.whites === gameState.wordLength) {
                    console.log('Player won!');
                    updates[`gameState/winner`] = gameState.playerId;
                    updates[`status`] = 'finished';
                } else {
                    console.log('Game continues, switching turns...');
                    // Switch turns
                    const nextTurn = gameState.playerId === 'player1' ? 'player2' : 'player1';
                    updates[`gameState/currentTurn`] = nextTurn;
                }

                console.log('Sending updates to Firebase...');
                gameRef.update(updates).then(() => {
                    console.log('Updates sent successfully');
                    
                    // Clear input
                    document.getElementById('guessInput').value = '';
                    
                    // Add chat message
                    console.log('Adding chat message...');
                    addChatMessage(`${currentUser.username} r√§t: ${guess} (${result.blacks} Schwarz, ${result.whites} Wei√ü)`, 'system');
                    
                }).catch((error) => {
                    console.error('Error updating Firebase:', error);
                    alert('Fehler beim Speichern des Rateversuchs: ' + error.message);
                });
            }).catch((error) => {
                console.error('Error getting opponent secret word:', error);
                alert('Fehler beim Abrufen des gegnerischen Geheimworts: ' + error.message);
            });
        }

        // Chat Functions
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addChatMessage(message, 'own');
            input.value = '';
        }

        function addChatMessage(message, type = 'own') {
            console.log('addChatMessage called:', message, type);
            
            if (!gameRef) {
                console.error('gameRef is null!');
                return;
            }
            
            const chatId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            const chatData = {
                message: message,
                sender: type === 'system' ? 'system' : currentUser.username,
                timestamp: Date.now(),
                type: type
            };
            
            console.log('Sending chat data:', chatData);
            
            gameRef.child(`chat/${chatId}`).set(chatData).then(() => {
                console.log('Chat message sent successfully');
            }).catch((error) => {
                console.error('Error sending chat message:', error);
            });
        }

        function updateChat(chatData) {
            const chatMessages = document.getElementById('chatMessages');
            const messages = Object.values(chatData).sort((a, b) => a.timestamp - b.timestamp);
            
            chatMessages.innerHTML = '';
            
            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message';
                
                if (msg.type === 'system') {
                    messageDiv.className += ' system';
                    messageDiv.textContent = msg.message;
                } else if (msg.sender === currentUser.username) {
                    messageDiv.className += ' own';
                    messageDiv.innerHTML = `<strong>Du:</strong> ${msg.message}`;
                } else {
                    messageDiv.className += ' other';
                    messageDiv.innerHTML = `<strong>${msg.sender}:</strong> ${msg.message}`;
                }
                
                chatMessages.appendChild(messageDiv);
            });
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Win Notification
        function showWinNotification(isWinner, winnerName, gameData) {
            // Play sound effect
            playWinSound(isWinner);
            
            // Get secret words for display
            const mySecretWord = gameState.mySecretWord;
            const opponentId = gameState.playerId === 'player1' ? 'player2' : 'player1';
            const opponentSecretWord = gameData.players[opponentId].secretWord;
            
            // Create overlay
            const overlay = document.createElement('div');
            overlay.className = 'win-overlay';
            overlay.onclick = () => closeWinNotification();
            
            // Create notification
            const notification = document.createElement('div');
            notification.className = `win-notification ${isWinner ? '' : 'lose'}`;
            
            notification.innerHTML = `
                <h2>${isWinner ? 'üéâ Gewonnen!' : 'üòî Verloren!'}</h2>
                <p><strong>${winnerName}</strong> hat das Spiel gewonnen!</p>
                
                <div class="secret-word">
                    <strong>Dein Wort:</strong> ${mySecretWord}
                </div>
                <div class="secret-word">
                    <strong>Gegner-Wort:</strong> ${opponentSecretWord}
                </div>
                
                <p style="margin-top: 20px; font-size: 1em; opacity: 0.9;">
                    ${isWinner ? 
                        'Gl√ºckwunsch! Du hast das Geheimwort erraten!' : 
                        'Schade! Dein Gegner war schneller.'
                    }
                </p>
                
                <button onclick="closeWinNotification()">OK</button>
            `;
            
            // Add to DOM
            document.body.appendChild(overlay);
            document.body.appendChild(notification);
            
            // Store references for cleanup
            window.currentWinNotification = { overlay, notification };
        }

        function closeWinNotification() {
            if (window.currentWinNotification) {
                const { overlay, notification } = window.currentWinNotification;
                if (overlay && overlay.parentNode) overlay.remove();
                if (notification && notification.parentNode) notification.remove();
                window.currentWinNotification = null;
            }
        }

        function playWinSound(isWinner) {
            try {
                // Create audio context for sound effects
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                if (isWinner) {
                    // Victory sound: ascending notes
                    playNote(audioContext, 523.25, 0.1, 0.0);   // C5
                    playNote(audioContext, 659.25, 0.1, 0.15);  // E5
                    playNote(audioContext, 783.99, 0.1, 0.3);   // G5
                    playNote(audioContext, 1046.5, 0.3, 0.45);  // C6
                } else {
                    // Defeat sound: descending notes
                    playNote(audioContext, 523.25, 0.2, 0.0);   // C5
                    playNote(audioContext, 392.00, 0.2, 0.25);  // G4
                    playNote(audioContext, 329.63, 0.4, 0.5);   // E4
                }
            } catch (error) {
                console.log('Audio not supported or blocked:', error);
            }
        }

        function playNote(audioContext, frequency, duration, delay) {
            setTimeout(() => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            }, delay * 1000);
        }

        // Utility Functions
        function calculateGuessResult(guess, secret) {
            let whites = 0;
            let blacks = 0;
            let secretChars = secret.split('');
            let guessChars = guess.split('');

            // Count whites (correct position)
            for (let i = 0; i < guess.length; i++) {
                if (guess[i] === secret[i]) {
                    whites++;
                    secretChars[i] = null;
                    guessChars[i] = null;
                }
            }

            // Count blacks (wrong position)
            for (let i = 0; i < guessChars.length; i++) {
                if (guessChars[i] !== null) {
                    const secretIndex = secretChars.indexOf(guessChars[i]);
                    if (secretIndex !== -1) {
                        blacks++;
                        secretChars[secretIndex] = null;
                    }
                }
            }

            return { whites, blacks };
        }

        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
            element.style.display = 'block';
            
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        // Initialize
        window.addEventListener('load', () => {
            console.log('Schwarz Wei√ü Vollversion geladen');
            
            // Test Firebase connection
            database.ref('.info/connected').on('value', (snapshot) => {
                if (snapshot.val() === true) {
                    console.log('‚úÖ Firebase verbunden');
                } else {
                    console.log('‚ùå Firebase nicht verbunden');
                }
            });
            
            // Test button clicks
            console.log('Testing button elements...');
            const registerBtn = document.querySelector('button[onclick="register()"]');
            const loginBtn = document.querySelector('button[onclick="login()"]');
            
            console.log('Register button found:', !!registerBtn);
            console.log('Login button found:', !!loginBtn);
        });
    </script>
</body>
</html>
